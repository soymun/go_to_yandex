# [[Оглавление]]

# Что такое Bitecode

Байт-код (bytecode) - это промежуточное представление Java-программы между исходным кодом и машинным кодом. Основные характеристики:

- **Платформонезависимость**: байт-код выполняется на JVM, что обеспечивает переносимость
- **Компактность**: более компактный, чем исходный код, но читаемый для анализа
- **Безопасность**: проходит верификацию перед выполнением
- **Оптимизация**: JIT-компилятор оптимизирует часто используемый байт-код

# Структура файла class

Файл `.class` имеет строго определенную структуру:

### Magic Number
- Первые 4 байта: `0xCAFEBABE`
- Идентифицирует файл как Java class

### Version Information
- Minor version (2 байта)
- Major version (2 байта)
- Определяет версию JVM

### Constant Pool
- Таблица констант (строки, числа, имена классов/методов)
- Индексируется начиная с 1

### Access Flags
- Модификаторы класса (public, final, abstract и т.д.)

### Class Information
- This class (индекс в constant pool)
- Super class (индекс в constant pool)
- Interfaces (массив индексов)

### Fields
- Описание полей класса
- Access flags, имя, дескриптор, атрибуты

### Methods
- Описание методов класса
- Access flags, имя, дескриптор, код

### Attributes
- Дополнительная информация (SourceFile, LineNumberTable и т.д.)

# Основные опкоды

### Загрузка констант
- `iconst_<n>`: загрузка констант от -1 до 5
- `ldc`: загрузка из constant pool
- `aconst_null`: загрузка null

### Работа с локальными переменными
- `iload_<n>`, `aload_<n>`: загрузка на стек
- `istore_<n>`, `astore_<n>`: сохранение со стека
- `iinc`: инкремент локальной переменной

### Арифметические операции
- `iadd`, `isub`, `imul`, `idiv`: целочисленные операции
- `ladd`, `fadd`, `dadd`: для long, float, double

### Сравнения и переходы
- `if_icmpeq`, `if_icmpne`: сравнение int
- `goto`: безусловный переход
- `ifnull`, `ifnonnull`: проверка на null

### Работа с объектами
- `new`: создание объекта
- `getfield`, `putfield`: доступ к полям
- `getstatic`, `putstatic`: статические поля

### Работа с массивами
- `newarray`: создание массива примитивов
- `anewarray`: создание массива объектов
- `arraylength`: получение длины массива
- `iaload`, `iastore`: загрузка/сохранение элементов

# Работа invoke

invokespecial - Используется для:
- Вызов конструкторов
- Приватных методов
- Методов суперкласса

 invokevirtual - Для обычных методов экземпляра:
- Поддерживает полиморфизм
- Виртуальная диспетчеризация

invokestatic - Для статических методов:

invokeinterface - Для методов интерфейсов:
- Более медленный поиск метода
- Проверка реализации интерфейса

invokedynamic  — это инструкция байт-кода, добавленная в JVM в Java 7, чтобы поддерживать динамическое связывание методов. В отличие от традиционных инструкций (`invokevirtual`, `invokestatic`, `invokeinterface`, `invokespecial`), которые фиксируют метод на этапе компиляции, `invokedynamic` позволяет определить логику вызова метода во время выполнения. Это делает её идеальной для реализации динамических языков (например, JRuby, Groovy) и таких функций, как лямбда-выражения в Java 8.

**Цели введения**:
- **Поддержка динамических языков**: Динамические языки, такие как Python или JavaScript, часто не имеют строгого определения метода на этапе компиляции. `invokedynamic` позволяет JVM гибко обрабатывать такие случаи.
- **Оптимизация производительности**: Динамическое связывание позволяет JVM оптимизировать вызовы методов, например, через инлайн-кэширование.
- **Расширяемость**: `invokedynamic` предоставляет разработчикам возможность настраивать поведение вызовов методов, что используется, например, в лямбда-выражениях и метод-хэндлах (Method Handles).

**Основные компоненты**:

- **Call Site**: Объект, представляющий точку вызова `invokedynamic`. Он хранит информацию о том, как выполнять вызов.
- **Bootstrap Method**: Метод, написанный на Java (или нативном коде), который вызывается JVM для инициализации вызова. Он возвращает объект `CallSite`, определяющий поведение вызова.
- **Dynamic Linkage**: JVM откладывает связывание до момента выполнения, а не фиксирует его на этапе компиляции.
# [[Оглавление]]