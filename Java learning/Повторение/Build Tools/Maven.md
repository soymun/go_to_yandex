# Автоматизация сборки

Сборка (англ. assembly) - двоичный файл, содержащий исполняемый код программы или другой, подготовленный для использования информационный продукт. Автоматизация сборки - этап написания скриптов или автоматизация широкого спектра задач применительно к ПО, применяемому разработчиками в их повседневной деятельности, включая такие действия, как:

Компиляция исходного кода в бинарный код Сборка бинарного кода Выполнение тестов Разворачивание программы на производственной платформе Написание сопроводительной документации или описание изменений новой версии
# Maven

Apache Maven - это фреймворк для автоматизации сборки проектов, компиляции, создания jar, создания дистрибутива программы, генерации документации. Если собирать большие проекты с командной строки, то команда для сборки будет очень длинной, поэтому её иногда записывают в bat/sh скрипт. Но такие скрипты зависят от платформы. Для того чтобы избавиться от этой зависимости и упростить написание скрипта используют инструменты для сборки проекта.

Maven, обеспечивает декларативную, а не императивную сборку проекта. То есть, в файлах проекта pom.xml содержится его декларативное описание, а не отдельные команды. Все задачи по обработке файлов Maven выполняется через плагины.

Основные преимущества Maven:

Независимость от OS. Сборка проекта происходит в любой операционной системе. Файл проекта один и тот же.

Управление зависимостями. Редко какие проекты пишутся без использования сторонних библиотек(зависимостей). Эти сторонние библиотеки зачастую тоже в свою очередь используют библиотеки разных версий. Maven позволяет управлять такими сложными зависимостями. Что позволяет разрешать конфликты версий и в случае необходимости легко переходить на новые версии библиотек.

Возможна сборка из командной строки. Такое часто необходимо для автоматической сборки проекта на сервере (Continuous Integration).

Хорошая интеграция со средами разработки. Основные среды разработки на java легко открывают проекты которые собираются c помощью maven. При этом зачастую проект настраивать не нужно - он сразу готов к дальнейшей разработке.

Как следствие - если с проектом работают в разных средах разработки, то maven удобный способ хранения настроек. Настроечный файл среды разработки и для сборки один и тот же - меньше дублирования данных и соответственно ошибок.

Декларативное описание проекта.

Недостатки Maven:

Неочевидность. Если в Ant указывается команда на удаление - и удаляется файл, то в случае Maven надо всем сердцем довериться плагину и документации по нему.

При таком объёме необходимых знаний документации не так много, особенно по каким-то специальным моментам. Да и просто читать придётся много. Порог вхождения, если потребуется собирать даже не самое сложное приложение куда выше, чем у Ant.

Если нужно найти какой-то специальный плагин - это будет сделать непросто, плагинов много. И не факт, что найденный подойдёт на все 100% и будет работать без ошибок.

Нужен доступ в интернет (или придётся разворачивать собственный репозиторий, что трудоёмко) Большие трудности, если проект не типовой.

# Аспектами управляемые Maven

Вот основные аспекты, которыми позволяет управлять Maven: 
1. Создание (Build) 
2. Документирование (Documentation) 
3. Отчёты (Reporting) 
4. Зависимости (Dependencies) 
5. Релизы (Releases) 
6. SCM Список рассылки (Mailing list) 
7. Дистрибьюция (Distribution)
# Структура каталогов в Maven

В Maven стандартная структура каталогов, благодаря ей отпадает необходимость прописывать пути к файлам проекта. В корневом каталоге проекта находится pom.xml и несколько текстовых файлов. Всё остальное хозяйство аккуратно разложено в подкаталогах. Главные из них - src и target.

# pom.xml

pom.xml - это XML-файл, который содержит информацию о деталях проекта, и конфигурации используемых для создания проекта на Maven. Он всегда находится в базовом каталоге проекта. Этот файл также содержит задачи и плагины. Во время выполнения задач, Maven ищет файл pom.xml в базовой директории проекта. Он читает его и получает необходимую информацию, после чего выполняет задачи. Корневой элемент , схема, которая облегчает редактирование и проверку, и версия pom.xml. Внутри тега project содержится основная и обязательная информация о проекте.

Среди информации которую содержит pom.xml мы можем выделить следующие: Зависимости проекта (project dependencies) Плагины (plugins) Задачи/цели (goals) Профиль создания (build profiles) Версия проекта (project version) Разработчики (developers) Список рассылки (mailing list)

# Супер POM

Все POM - файлы являются наследниками родительского pom.xml. Этот POM-файл называется Super POM и содержит значения, унаследованные по умолчанию.

Все POM-и наследуются от родителя (несмотря на то явно определен он или нет). Это базовый POM известный как супер POM, он содержит значения, которые наследуются по умолчанию.

# Элементы необходимые для минимального POM

Требуемые элементы для минимального POM это корневой элемент, modelVersion, GroupID, artifactID и версия

# Зависимости в Maven

Зависимость (dependency) - это те библиотеки, которые непосредственно используются в вашем проекте для компиляции кода или его тестирования.

# Порядок поиска зависимостей Maven

Когда мы выполняем собрку проекта в Maven, автоматически начинается поиск необходимых зависимостей в следующем порядке:

Поиск зависимостей в локальном репозитории Если зависимости не обнаружены, происходит переход к шагу 2.

Поиск зависимостей в центральном репозитории. Если они не обнаружены и удалённый репозиторий определён, то происходит переход к шагу 4.

Если удалённый репозиторий не определён, то процесс сборки прекращается и выводится сообщение об ошибке.

Поиск зависимостей на удалённом репозитории, если они найдены, то происходит их загрузка в локальный репозиторий, если нет - выводится сообщение об ошибке.

# Внешние зависимости

Если необходимые файлы не найдены ни в центральном, ни на удалённом репозитории, тогда для решения этой проблемы используются внешние зависимости.

Внешние зависимости могут быть сконфигурированы в файле pom.xml таким же образом, как и другие зависимости, для этого:

Определите groupId таким же именем, как и имя файла.

Определите artifactId таким же именем, как и имя файла.

Определите область видимости зависимости, как system.

Укажите абсолютный путь к файлу.

# Транзитивная зависимость

Транзитивная зависимость - позволяет избегать необходимости изучать и указывать библиотеки, которые требуются для самой зависимости, и включает их автоматически. Необходимые библиотеки подгружаются в проект автоматически. При разрешении конфликта версий используется принцип «ближайшей» зависимости, то есть выбирается зависимость, путь к которой через список зависимых проектов является наиболее коротким.

# Как Maven определяет какую версию зависимостей использовать когда встречается множественный вариант выбора?

Dependency mediation - определяет, какая версия зависимости будет использоваться, когда встречается несколько версий артефактов, если две версии зависимости на той же глубине в дереве зависимостей, то будет использоваться та которая объявлена первой. Здесь важен порядок объявления: первое объявление выигрывает.

# Область видимости зависимостей (dependency scope)

Существует 6 областей:

compile - это область по умолчанию, использутся, если ничего больше не определено. Compile зависимости доступны во всех classpath проекта.

provided - это очень похоже на compile, но указывает на то, что вы ожидаете от JDK или контейнера предоставить зависимость в ходе выполнения. Эта область доступна только на compilation и test classpath и не является транзитивной.

runtime - эта область указывает на то, что зависимость не обязательна для compilation, но для фаз выполнения.

test - эта область указывает, что зависимость не обязательна для нормального использования приложения.

system - эта область похожа на provided за исключением того, что вы предоставляете JAR. Артефакт всегда доступен и не смотрит в репозиторий.

import - эта область используется в зависимости типа pom в разделе. Это указывает на то, что определенный POM будет заменен зависимостями в этом POM разделе.

# dependencyManagement

В родительском POM основное различие между и заключается в следующем:

Артефакты, указанные в разделе, ВСЕГДА будут включены в качестве зависимостей дочерних модулей.

Артефакты, указанные в разделе, будут включены в дочерний модуль только в том случае, если они также были указаны в разделе самого дочернего модуля.

Потому что вы указываете версию и / или область действия в родительском, и вы можете не указывать их при указании зависимостей в дочернем POM. Это может помочь вам использовать унифицированные версии для зависимостей для дочерних модулей, не указывая версию в каждом дочернем модуле.

# Артефакт в Maven

Артефакт (artefact) - это, по сути, любая библиотека, хранящаяся в репозитории (месте хранения). Это может быть какая-то зависимость или плагин. Обычно артефактом является JAR-файл, который хранится в репозитории Maven. Каждый артефакт содержит group ID, artifact ID и версию.

# Плагин в Maven

Плагин (plugin) - это зависимости Maven'а, расширяющие его функционал.

В Maven существует два типа плагинов:

Плагины сборки (Build plugins) - выполняются в процессе сборки и должны быть конфигурированны внутри блока файла pom.xml.

Плагины отчётов (Reporting plugins) - выполняются в процесса генерирования сайта и должны быть конфигурированны внутри блока файла pom.xml.


Очень часто плагин используется для того, чтобы во время выполнения определенной фазы запустить какую-нибудь консольную утилиту. Более того, мы можем запустить даже обычный Java-класс (у которого есть метод main, конечно).
# Задача в Maven

Задача (goal) - это специальная задача, которая относится к сборке проекта и его управлению. Она может привязываться как к нескольким фазам, так и ни к одной. Задача, которая не привязана ни к одной фазе, может быть запущена вне фаз сборки с помощью прямого вызова.

В Maven есть еще такое понятие как цель (goal). goal - это как бы цель запуска Maven'а. Основные цели совпадают с основными фазами:
1. validate; 
2. compile; 
3. test; 
4. package; 
5. verify;
6. install;
7. deploy.

В каждой фазе жизненного цикла проекта вызывается определенный плагин (jar-библиотека), который включает некоторое количество целей (goal)

Например, плагин «maven-compiler-plugin» содержит две цели: compiler:compile для компиляции основного исходного кода проекта и compiler:testCompile для компиляции тестов. Формально, список фаз можно изменять, хотя необходимость в этом бывает редко.

# Жизненный цикл сборки в Maven

Жизненный цикл сборки(Lifecycle) - это чётко опредлённая последовательность фаз во время выполнения которых должын быть достигнуты определённые цели. Здесь фаза представляет собой стадию жизненного цикла.

Основные фазы сборки

validate - проверяет корректность метаинформации о проекте

compile - компилирует исходники

test - прогоняет тесты классов из предыдущего шага

package - упаковывает скомпилированные классы в новый артефакт: jar, war, zip, ...

verify - проверяет корректность артефакта и удовлетворение требованиям качества

install - кладет артефакт в локальный репозиторий

deploy - заливает артефакт на production-сервер или удаленный репозиторий

При этом шаги четко последовательны. Если ты скомандуешь Maven выполнить команду package, он перед этим выполнит фазы validate, compile, test и только затем package

Когда Maven начинает сборку проекта, он проходит через определённую последовательность фаз сборки, и выполняет определенные задачи, которые указаны в каждой из фаз. В Maven есть следующие 3 стандартных жизненных цикла:

Очистка (clean) - очищает артефакты, созданные до сборки.

Сборка (default or build) - используется для создания приложения.

Создание сайта проекта (site) - генерирует документацию сайта для проекта.

# Жизненный цикл сборки Clean

Жизненный цикл сборки Clean состоит из следующих этапов: pre-clean clean post-clean

# Фазы жизненного цикла сборки Default (Build)

Default (Build) - это основной жизненный цикл Maven, который используется для сборки проектов. Он включает в себя 23 фазы:

validate - проверяет корректность метаинформации о проекте, подтверждает, является ли проект корректным и вся ли необходимая информация доступа для завершения процесса сборки.

initialize - инициализирует состояние сборки, например, различные настройки.

generate-sources - включает любой исходный код в фазу компиляции.

process-sources - обрабатывает исходный код (подготавливает). Например, фильтрует определённые значения.

generate-resources - генерирует ресурсы, которые должны быть включены в пакет.

process-resources - копирует и отправляет ресурсы в указанную директори. Это фаза перед упаковкой.

compile - комплирует исходный код проекта.

process-classes - обработка файлов, полученных в результате компляции. Например, оптимизация байт-кода Java классов.

generate-test-sources - генерирует любые тестовые ресурсы, которые должны быть включены в фазу компиляции.

process-test-sources - обрабатывает исходный код тестов. Например, фильтрует значения.

test-compile - компилирует исходный код тестов в указанную директорию тестов.

process-test-classes - обрабатывает файлы, полученные в результате компиляции исходного кода тестов.

test - запускает тесты классов, используя приемлемый фреймворк юнит-тестирования (например, Junit).

prepare-package - выполняет все необходимые операции для подготовки пакета, непосредственно перед упаковкой.

package - преобразует скомпилированный код и пакет в дистрибутивный формат. Такие как JAR, WAR или EAR.

pre-integration-test - выполняет необходимые действия перед выполнением интеграционных тестов.

integration-test - обрабатывает и распаковывает пакет, если необходимо, в среду, где будут выполняться интеграционные тесты.

post-integration-test - выполняет действия, необходимые после выполнения интеграционных тестов. Например, освобождение ресурсов.

verify - выполняет любые проверки для подтверждения того, что пакет пригоден и отвечает критериям качества.

install - переносит пакет в локальный репозиторий, откуда он будет доступен для использования как зависимость в других проектах.

deploy - копирует финальный пакет (архив) в удалённый репозиторий для, того, чтобы сделать его доступным другим разработчикам и проектам.

Здесь также необходимо уточнить два момента:

Когда мы выполняем команду Maven, например install, то будут выполенны фазы до install и фаза install.

Различные задачи Maven будут привязаны к различным фазам жизненнго цикла Maven в зависимости от типа архива (JAR/WAR/EAR).



# Архетип в Maven

Архетип (archetype) - это некая стандартная компоновка файлов и каталогов в проектах различного рода (веб, swing-проекты и прочие). Другими словами, Maven знает, как обычно строятся проекты и в соответствии с архетипом создает структуру каталогов.

# Репозиторий в Maven

Репозиторий (repository) - глобальное хранилище всех библиотек, доступных для Maven, это место где хранятся артефакты: jar файлы, pom-файлы, javadoc, исходники, плагины.

В Maven существуют три типы репозитория:

Локальный (local) репозиторий - это директория, которая хранится на нашем компьютере. Она создаётся в момент первого выполнения любой команды Maven. По умолчанию она расположена в <home директория>/.m2/repository - персональная для каждого пользователя.

Центральный (central) репозиторий - это репозиториий, который обеспечивается сообществом Maven. Он содержит огромное количество часто используемых библиотек. Который расположен в [http://repo1.maven.org/maven2/](http://repo1.maven.org/maven2/) и доступен на чтение для всех пользователей в интернете. Если Maven не может найти зависимости в локальном репозитории, то автоматически начинается поиск необходимых файлов в центральном репозитории

Удалённые (remote) репозиторий - иногда, Maven не может найти необходимые зависимости в центральном репозитории. В этом случае, процесс сборки прерывается и в консоль выводится сообщение об ошибке. Для того, чтобы предотвратить подобную ситуацию, в Maven предусмотрен механизм Удалённого репозитория, который является репозиторием, который определяется самим разработчиком. Там могут храниться все необходимые зависимости.

# Профиль сборки (Build Profile)

Профиль сборки - это множество настроек, которые могут быть использованы для установки или перезаписи стандартных значений сборки Maven. Используя профиль сборки Maven, мы можем настраивать сборку для различных окружений, таких как Разработка или Продакшн. Профили настраиваются в файле pom.xml с помощью элементов activeProfiles / profiles и запускаются различными методами.

# Типы профилей сборки (Build Profiles)

В Maven существует три основных типа профилей сборки: Per Project - определяется в POM файле, pom.xml Per User - определяется в настройках Maven - xml файл (%USER_HOME%/.m2/settings.xml). Global - определяется в глобальных настройках - xml файл (%M2_HOME%/conf/settings.xml).

# Переменные

Часто встречающиеся параметры Maven позволяет вынести в переменные. Это очень полезно, когда нужно чтобы в разных частях pom-файла параметры совпадали. Например, в переменную можно вынести версию Java, версии библиотеки, пути к определенным ресурсам. Для этого есть специальная секция в pom.xml - , в ней и объявляются переменные.

# SNAPSHOT

SNAPSHOT - это специальная версия, которая показывает текущую рабочую копию. При каждой сборке Maven проверяет наличие новой snapshot версии на удалённом репозитории.

**snapshot vs версия**

В случае с версией, если Maven однажды загрузил версию data-service:1.0, то он больше не будет пытаться загрузить новую версию 1.0 из репозитория. Для того, чтобы скачать обновлённый продукт data-service должен быть обновлён до версии 1.1.

В случае со snapshot, Maven автоматически будет подтягивать крайний snapshot (data-service:1.0-SNAPSHOT) каждый раз, когда будет выполнятся сборка проекта.

# Основные команды

 **`mvn site`**: Эта команда **генерирует веб-сайт проекта**. Он содержит документацию, отчеты о тестировании, информацию о зависимостях и другую полезную информацию. Этот сайт создается в директории `target/site`.
**`mvn clean`**: Эта команда **очищает** директорию `target` (целевую директорию), удаляя все сгенерированные файлы, включая `.jar`, `.war` и скомпилированные `.class` файлы. Это полезно, чтобы начать "чистую" сборку.
**`mvn package`**: Эта команда **компилирует исходный код** проекта, запускает тесты и **упаковывает** скомпилированный код в итоговый артефакт (например, `.jar` или `.war` файл). Она включает в себя фазу `compile` и `test`.
**`mvn dependency:copy-dependencies`**: Это **цель** (goal) плагина `maven-dependency-plugin`. Она **копирует все зависимости** проекта в указанную директорию, обычно `target/dependency`. Это полезно, когда нужно собрать все `.jar` файлы, от которых зависит ваше приложение, в одном месте.
**`mvn clean install`**: Одна из самых часто используемых команд. Она сначала **очищает** проект (`clean`), затем **собирает** его (`package`), запускает тесты и, наконец, **устанавливает** сгенерированный артефакт в локальный репозиторий Maven. Это позволяет другим проектам на вашем компьютере использовать этот артефакт как зависимость.
